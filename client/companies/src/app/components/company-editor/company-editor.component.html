<div class="loading-wrapper" *ngIf="loading">
  <div class="loading">
    <mat-spinner></mat-spinner>
  </div>
</div>

<div class="error" *ngIf="!loading && error">
  <p>
    Something went wrong while fetching the company!
  </p>

  <button mat-button (click)="retry()">Try again!</button>
</div>

<div class="company-wrapper" [class.canUpdate]="canUpdate" [class.updating]="updating" [class.update-error]="updateError || updateConflict" [class.updated]="updated" *ngIf="!loading && !error">
  <a class="cancel-link" mat-button href="/company/{{company.id}}">
    <mat-icon>cancel</mat-icon>
    Cancel
  </a>
  <h1>Edit company</h1>

  <div class="edit-area">
    <div class="drone">
        <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="svg26" xml:space="preserve"
             enable-background="new 0 0 800 600"
             viewBox="0 0 800 600"
             y="0px" x="0px" version="1.1"
             class="drone-svg">
          <defs id="defs30">
            <linearGradient id="linearGradient4614">
              <stop id="stop4610" offset="0" style="stop-color:#cbffff;stop-opacity:1" />
              <stop style="stop-color:#beffff;stop-opacity:0.7019608" offset="0.82761687" id="stop4618"/>
              <stop id="stop4612" offset="1" style="stop-color:#edffff;stop-opacity:0"/>
            </linearGradient>
            <linearGradient id="linearGradient4606">
              <stop id="stop4602" offset="0" style="stop-color:#00ffff;stop-opacity:1;" />
              <stop id="stop4604" offset="1" style="stop-color:#00ffff;stop-opacity:0;"/>
            </linearGradient>
            <linearGradient gradientUnits="userSpaceOnUse" y2="365.0589" x2="208.98601" y1="303.48666" x1="208.08714" id="linearGradient4608" xlink:href="#linearGradient4606"/>
            <linearGradient gradientTransform="translate(0,8)" gradientUnits="userSpaceOnUse" y2="349.32877" x2="213.92976" y1="331.8009" x1="214.82863" id="linearGradient4616" xlink:href="#linearGradient4614"/>
            <linearGradient gradientTransform="translate(353.7032)" y2="365.0589" x2="208.98601" y1="303.48666" x1="208.08714" gradientUnits="userSpaceOnUse" id="linearGradient4630" xlink:href="#linearGradient4606"/>
            <linearGradient y2="349.32877" x2="213.92976" y1="331.8009" x1="214.82863" gradientTransform="translate(353.7032,8)" gradientUnits="userSpaceOnUse" id="linearGradient4632" xlink:href="#linearGradient4614"/>
          </defs>
          <ellipse style="fill:url(#linearGradient4630);fill-opacity:1;stroke-width:0.92998111;stroke-linecap:round;stroke-linejoin:round" id="right-flame" cx="576.17218" cy="321.46396" rx="14.381833" ry="48.089252"/>
          <ellipse ry="48.089252" rx="14.381833" cy="321.46396" cx="222.46898" id="left-flame" style="fill:url(#linearGradient4608);fill-opacity:1;stroke-width:0.92998111;stroke-linecap:round;stroke-linejoin:round"/>
          <path d="m 578.08,271.2 c -2.62845,-0.43515 -4.07363,-0.53854 -5.759,-0.48 -2.4,-0.48 -3.84,-0.48 -3.84,-0.48 H 463.84 L 452.32,249.6 c -0.96,-1.44 -3.36,-2.88 -5.28,-2.88 h -28.32 c -5.279,-4.8 -11.52,-8.16 -18.72,-8.16 -7.2,0 -13.92,3.36 -18.72,8.16 h -28.32 c -1.92,0 -4.32,1.44 -5.28,2.88 l -11.52,20.64 H 232 c 0,0 -1.44,0 -3.84,0.48 -1.91179,0.28748 -3.65576,0.47827 -6.24,0.96 -7.68,1.44 -16.8,4.32 -16.8,10.08 0,10.08 6.24,27.84 15.36,27.84 9.12,0 11.04,-4.8 11.04,-4.8 l 11.04,-25.92 h 108.96 l 8.16,23.521 c -7.2,7.68 -15.84,19.68 -15.84,31.68 0,22.08 3.84,28.8 3.84,28.8 0,0 3.84,9.601 4.32,-1.439 0.48,-11.04 -3.36,-10.561 -3.36,-28.32 0,-9.12 7.2,-19.2 13.92,-26.88 h 74.4 c 6.72,7.68 13.92,17.76 13.92,26.88 0,17.28 -3.84,16.8 -3.359,28.32 0.479,11.52 4.319,1.439 4.319,1.439 0,0 3.84,-6.72 3.84,-28.8 0,-12 -8.159,-23.521 -15.84,-31.68 L 448,278.88 H 556.96 L 568,304.8 c 0,0 1.44,4.8 11.04,4.8 9.601,0 15.36,-18.24 15.36,-27.84 0,-6.24 -9.12,-9.12 -16.32,-10.56 z"
            id="path8" style="fill:#010101"/>
          <path d="m 442.5,350.5 h -85 c -2.2,0 -4,1.8 -4,4 v 22 c 0,2.2 1.8,4 4,4 h 85 c 2.2,0 4,-1.8 4,-4 v -22 c 0,-2.2 -1.8,-4 -4,-4 z"
            id="path12" style="fill:#010101"/>
          <path d="m 368.5,338.5 v 11 h 62 v -11 c 0,-2.2 -1.8,-4 -4,-4 h -54 c -2.2,0 -4,1.8 -4,4 z"
            id="path14" style="fill:#010101"/>
          <polygon
            points="435.055,442.42 364.408,442.42 368.605,484.5 430.856,484.5 "
            id="polygon16" style="fill:#010101"/>
          <polygon
            points="441.133,381.5 358.33,381.5 361.381,412.086 438.081,412.086 "
            id="polygon20" style="fill:#010101"/>

          <ellipse
            style="fill:#f00;fill-opacity:1;stroke-width:0;stroke-linecap:round;stroke-linejoin:round"
            id="circle-lamp"
            cx="400"
            cy="267"
            rx="10"
            ry="10" />
          <ellipse
            style="fill:#000;fill-opacity:1;stroke-width:0;stroke-linecap:round;stroke-linejoin:round"
            id="circle-coffee"
            cx="400"
            cy="427"
            rx="10"
            ry="10" />

          <ellipse
            style="fill:url(#linearGradient4616);fill-opacity:1;stroke-width:0.5521763;stroke-linecap:round;stroke-linejoin:round"
            id="left-bright-flame"
            cx="222.46898" cy="329.46396" rx="8.5392132" ry="28.552994"/>
          <g id="g4578">
            <path id="path4566" style="fill:#000000;stroke:#000000;stroke-width:1px;stroke-linecap:round;stroke-linejoin:round;stroke-opacity:1" d="m 243.3687,284.11017 c 0,0 5.88709,22.24562 -4.75909,44.49138 m 0,0 c 0,0 -1.43171,-0.38779 -2.2543,-1.43009 -0.79365,-1.00561 -4.36378,-4.1312 -14.21547,-4.1312 -9.8517,0 -12.94442,3.03819 -13.58002,3.99158 -0.63559,0.95339 -2.06568,1.43009 -2.06568,1.43009 -11.12288,-23.83474 -4.21659,-44.35176 -4.21659,-44.35176 0,0 7.94492,-2.38348 20.49789,-2.38348 12.55296,0 20.59326,2.38348 20.59326,2.38348" />
            <path style="fill:#000000;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" d="m 216.89619,325.26483 c 0,0 2.86017,10.16949 5.24364,10.16949 2.38348,0 4.92585,-10.32838 4.92585,-10.32838 0,0 -2.22458,-0.6356 -5.08475,-0.6356 -2.86017,0 -5.08474,0.79449 -5.08474,0.79449 z" id="path4572"/>
          </g>
          <ellipse ry="28.552994" rx="8.5392132"
            cy="329.46396" cx="576.17218"
            id="right-bright-flame" style="fill:url(#linearGradient4632);fill-opacity:1;stroke-width:0.5521763;stroke-linecap:round;stroke-linejoin:round"/>
          <g transform="translate(353.7032)" id="g4628">
            <path d="m 243.3687,284.11017 c 0,0 5.88709,22.24562 -4.75909,44.49138 m 0,0 c 0,0 -1.43171,-0.38779 -2.2543,-1.43009 -0.79365,-1.00561 -4.36378,-4.1312 -14.21547,-4.1312 -9.8517,0 -12.94442,3.03819 -13.58002,3.99158 -0.63559,0.95339 -2.06568,1.43009 -2.06568,1.43009 -11.12288,-23.83474 -4.21659,-44.35176 -4.21659,-44.35176 0,0 7.94492,-2.38348 20.49789,-2.38348 12.55296,0 20.59326,2.38348 20.59326,2.38348" style="fill:#000000;stroke:#000000;stroke-width:1px;stroke-linecap:round;stroke-linejoin:round;stroke-opacity:1" id="path4624" />
            <path id="path4626" d="m 216.89619,325.26483 c 0,0 2.86017,10.16949 5.24364,10.16949 2.38348,0 4.92585,-10.32838 4.92585,-10.32838 0,0 -2.22458,-0.6356 -5.08475,-0.6356 -2.86017,0 -5.08474,0.79449 -5.08474,0.79449 z" style="fill:#000000;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"/>
          </g>
      </svg>
    </div>


    <div class="fields">
      <div class="field">
        <mat-form-field>
          <input matInput placeholder="Name" #name [(ngModel)]="company.name" [readonly]="updating" required="required"/>

          <mat-error *ngIf="!company.name">
            Name is <strong>required</strong>
          </mat-error>
          <span class="diff-error" *ngIf="updateConflict && isConflicted(initialCompany.name, editedCompany.name, company.name)" (click)="company.name = editedCompany.name; detectChanges()">
            <em>Use the name you wrote?</em> (<strong>{{editedCompany.name}}</strong>)
          </span>
        </mat-form-field>
      </div>

      <div class="field">
        <mat-form-field>
          <input matInput placeholder="Address" #address [(ngModel)]="company.address" [readonly]="updating" required="required"/>

          <mat-error *ngIf="!company.address">
            Address is <strong>required</strong>
          </mat-error>
          <span class="diff-error" *ngIf="updateConflict && isConflicted(initialCompany.address, editedCompany.address, company.address)" (click)="company.address = editedCompany.address; detectChanges()">
            <em>Use the address you wrote?</em> (<strong>{{editedCompany.address}}</strong>)
          </span>
        </mat-form-field>
      </div>

      <div class="field">
        <mat-form-field>
          <input matInput placeholder="City" #city [(ngModel)]="company.city" [readonly]="updating" required="required"/>

          <mat-error *ngIf="!company.city">
            City is <strong>required</strong>
          </mat-error>
          <span class="diff-error" *ngIf="updateConflict && isConflicted(initialCompany.city, editedCompany.city, company.city)" (click)="company.city = editedCompany.city; detectChanges()">
            <em>Use the city you wrote?</em> (<strong>{{editedCompany.city}}</strong>)
          </span>
        </mat-form-field>
      </div>

      <div class="field">
        <mat-form-field>
          <input matInput placeholder="Country" #country [(ngModel)]="company.country" [readonly]="updating" required="required"/>

          <mat-error *ngIf="!company.country">
            Country is <strong>required</strong>
          </mat-error>
          <span class="diff-error" *ngIf="updateConflict && isConflicted(initialCompany.country, editedCompany.country, company.country)" (click)="company.country = editedCompany.country; detectChanges()">
            <em>Use the country you wrote?</em> (<strong>{{editedCompany.country}}</strong>)
          </span>
        </mat-form-field>
      </div>

      <div class="field">
        <mat-form-field>
          <input matInput placeholder="Email (optional)" type="email" [(ngModel)]="company.email" [readonly]="updating"/>
          <span class="diff-error" *ngIf="updateConflict && isConflicted(initialCompany.email, editedCompany.email, company.email)" (click)="company.email = editedCompany.email; detectChanges()">
            <em>Use the email you wrote?</em> (<strong>{{editedCompany.email}}</strong>)
          </span>
        </mat-form-field>
      </div>

      <div class="field">
        <mat-form-field>
          <input matInput placeholder="Phone number (optional)" [(ngModel)]="company.phone" [readonly]="updating"/>
          <span class="diff-error" *ngIf="updateConflict && isConflicted(initialCompany.phone, editedCompany.phone, company.phone)" (click)="company.phone = editedCompany.phone; detectChanges()">
            <em>Use the phone you wrote?</em> (<strong>{{editedCompany.phone}}</strong>)
          </span>
        </mat-form-field>
      </div>
    </div>
  </div>

  <button class="update-button" mat-button [disabled]="!canUpdate" (click)="update()">
    <mat-icon>done</mat-icon> Update
  </button>

  <div class="updating-message" *ngIf="!updated && updating && !updateError">
    <mat-icon class="inline-icon">timer</mat-icon> We're updating the company!
  </div>

  <div class="updated-message" *ngIf="updated && !updating && !updateError">
    <mat-icon class="inline-icon">done</mat-icon> The company has been updated successfully!
  </div>

  <div class="update-error-message" *ngIf="!updated && !updating && updateError && !updateConflict">
    <mat-icon class="inline-icon">error</mat-icon> An error occurred while updating the company! Please try again!
  </div>

  <div class="update-error-message" *ngIf="!updated && !updating && !updateError && updateConflict">
    <mat-icon class="inline-icon">warning</mat-icon> Someone else updated the company before you! <br />

    Review their changes and try again!
  </div>
</div>
